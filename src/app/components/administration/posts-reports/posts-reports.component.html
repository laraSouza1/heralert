<div class="container px-6">

  <p-confirmDialog></p-confirmDialog>
  <p-toast></p-toast>

  <!--header componente notificações-->
  <div class="flex flex-row my-2 h-tag h-2rem align-content-center align-items-center">
    <div class="flex mr-2 w-6">Denúncias de postagens</div>
  </div>

  <div class="line my-3 pt-3">
    <p-iconfield iconPosition="left" class="ml-auto">
      <p-inputicon><i class="pi pi-search"></i></p-inputicon>
      <input pInputText type="text" placeholder="Pesquisar..." (input)="onSearch($event)" class="pesquisa" />
    </p-iconfield>
  </div>

  <div class="table-container">
    <div *ngIf="isLoading" class="loader-overlay">
      <div class="spinner"></div>
    </div>

    <p-tabView [(activeIndex)]="selectedTabIndex" (onChange)="onTabChange($event)">
      <p-tabPanel header="Em avaliação">
        <p-message severity="info">
          Atualize o estado das denúncias com cuidado. Caso erre, poderá voltar a atualizar o estado da denúncia
          específica nas abas "não válidas" ou "válidas".
        </p-message>
        <ng-template pTemplate="content">
          <table class="mt-2 w-full" *ngIf="!isLoading && reports.length > 0">
            <thead>
              <tr>
                <th>Ver post</th>
                <th>Data da Denúncia</th>
                <th>Título do Post</th>
                <th>Comunidade do Post</th>
                <th>Usuária Reportada</th>
                <th>Motivo da Denúncia</th>
                <th>Estado</th>
                <th>Atualizar estado</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let report of reports" style="cursor: pointer;">
                <td (click)="goToPostDetail(report.post_id, report.post_title, $event)">
                  <i class="pi pi-eye"></i>
                </td>
                <td>{{ report.report_created_at | date: 'dd-MM-yyyy' }}</td>
                <td>{{ report.post_title }}</td>
                <td>{{ report.post_community }}</td>
                <td (click)="goToProfile(report.reported_user_id, report.reported_username, $event)">
                  {{ report.reported_username }}
                </td>
                <td>{{ report.report_reason }}</td>
                <td>{{ getReportStatusText(report.report_status) }}</td>
                <td>
                  <i class="pi pi-pencil" (click)="openStatusDialog(report)"></i>
                </td>
              </tr>
            </tbody>
          </table>
          <div *ngIf="!isLoading && reports.length === 0" class="text-center py-4">
            Nenhum relatório "Em avaliação" encontrado.
          </div>
          <div *ngIf="isLoading" class="text-center py-4">
            Carregando relatórios...
          </div>
        </ng-template>
      </p-tabPanel>

      <p-tabPanel header="Não válidas">
        <p-message severity="warn">
          Denúncias não válidas podem ser excluídas. Isso irá excluir somente a denúncia em específica. Por favor,
          verifique se a denúncia realmente não é válida antes de tomar qualquer ação. Caso não seja, atualize o estado
          para "em avaliação" ou "válida".
        </p-message>
        <ng-template pTemplate="content">
          <table class="mt-2 w-full" *ngIf="!isLoading && reports.length > 0">
            <thead>
              <tr>
                <th>Ver post</th>
                <th>Data da Denúncia</th>
                <th>Título do Post</th>
                <th>Comunidade do Post</th>
                <th>Usuária Reportada</th>
                <th>Motivo da Denúncia</th>
                <th>Estado</th>
                <th>Motivo do estado</th>
                <th>Atualizar estado</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let report of reports" style="cursor: pointer;">
                <td (click)="goToPostDetail(report.post_id, report.post_title, $event)">
                  <i class="pi pi-eye"></i>
                </td>
                <td>{{ report.report_created_at | date: 'dd-MM-yyyy' }}</td>
                <td>{{ report.post_title }}</td>
                <td>{{ report.post_community }}</td>
                <td (click)="goToProfile(report.reported_user_id, report.reported_username, $event)">
                  {{ report.reported_username }}
                </td>
                <td>{{ report.report_reason }}</td>
                <td>{{ getReportStatusText(report.report_status) }}</td>
                <td>{{ report.status_reason_text }}</td>
                <td>
                  <i class="pi pi-pencil" (click)="openStatusDialog(report)"></i>
                </td>
              </tr>
            </tbody>
          </table>
          <div *ngIf="!isLoading && reports.length === 0" class="text-center py-4">
            Nenhum relatório "Não justificada" encontrado.
          </div>
          <div *ngIf="isLoading" class="text-center py-4">
            Carregando relatórios...
          </div>
        </ng-template>
      </p-tabPanel>

      <p-tabPanel header="Válidas">
        <p-message severity="error">
          Postagens com denúncias válidas devem ser excluídas! Isso irá excluir também todas as outras denúncias
          relacionadas a essa postagem. Por favor, verifique se a denúncia é realmente válida antes de tomar qualquer
          ação. Caso não seja, atualize o estado para "em avaliação" ou "não válida".
        </p-message>
        <ng-template pTemplate="content">
          <table class="mt-2 w-full" *ngIf="!isLoading && reports.length > 0">
            <thead>
              <tr>
                <th>Ver post</th>
                <th>Data da Denúncia</th>
                <th>Título do Post</th>
                <th>Comunidade do Post</th>
                <th>Usuária Reportada</th>
                <th>Motivo da Denúncia</th>
                <th>Estado</th>
                <th>Motivo do estado</th>
                <th>Atualizar estado</th>
                <th>Deletar post</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let report of reports" style="cursor: pointer;">
                <td (click)="goToPostDetail(report.post_id, report.post_title, $event)">
                  <i class="pi pi-eye"></i>
                </td>
                <td>{{ report.report_created_at | date: 'dd-MM-yyyy' }}</td>
                <td>{{ report.post_title }}</td>
                <td>{{ report.post_community }}</td>
                <td (click)="goToProfile(report.reported_user_id, report.reported_username, $event)">
                  {{ report.reported_username }}
                </td>
                <td>{{ report.report_reason }}</td>
                <td>{{ getReportStatusText(report.report_status) }}</td>
                <td>{{ report.status_reason_text }}</td>
                <td>
                  <i class="pi pi-pencil" (click)="openStatusDialog(report)"></i>
                </td>
                <td class="trash">
                  <i class="pi pi-trash" (click)="handleDeletePost(report)"></i>
                </td>
              </tr>
            </tbody>
          </table>
          <div *ngIf="!isLoading && reports.length === 0" class="text-center py-4">
            Nenhum relatório "Justificada" encontrado.
          </div>
          <div *ngIf="isLoading" class="text-center py-4">
            Carregando relatórios...
          </div>
        </ng-template>
      </p-tabPanel>
    </p-tabView>
    <p-paginator [rows]="limit" [totalRecords]="totalReports" [first]="first" (onPageChange)="onPageChange($event)">
    </p-paginator>
  </div>
</div>

<p-dialog [(visible)]="displayStatusDialog" modal [header]="'Atualizar estado denúncia de post'" [closable]="false"
  [style]="{ width: '50vw' }">
  <app-status-post [report]="selectedReport" (statusUpdated)="updateReportStatus($event)"
    (dialogClosed)="closeStatusDialog()" #statusPostRef></app-status-post>

  <ng-template pTemplate="footer">
    <p-button label="Cancelar" class="bt-post2" (click)="closeStatusDialog()"></p-button>
    <p-button label="Enviar" class="bt-post" pRipple (click)="submitStatusUpdateFromChild()"
      [disabled]="!statusPostRef?.FormValid()"></p-button>
  </ng-template>
</p-dialog>

<p-dialog [(visible)]="displayStatusDialog" modal [header]="'Ver detalhes da denúncia'" [closable]="true"
  [style]="{ width: '50vw' }">
  <app-see-post-report-detail></app-see-post-report-detail>

  <p-button label="Cancelar" class="bt-post2" (click)="closeStatusDialog()"></p-button>
</p-dialog>